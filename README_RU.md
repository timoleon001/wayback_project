# Скрипт Wayback

Этот скрипт извлекает заголовки архивных веб-страниц из Wayback Machine и записывает их в таблицу Google Sheets. Он обрабатывает домены, указанные в таблице в первом столбце, запрашивает у Wayback Machine последние (по умолчанию 3) снимка и извлекает содержимое тега `<title>` из самого старого из них, записывая его в последнюю доступную колонку. Процесс логируется, и данные сохраняются в файл `wayback_script.log`.

## Особенности
- Извлекает до 3 снимков для каждого домена из Wayback Machine.
- Извлекает `<title>` из самого старого снимка.
- Записывает результаты в таблицу Google Sheets пакетами (по умолчанию 5 доменов).
- Включает подробное логирование для отладки и мониторинга.
- Обработка ошибок (например, таймауты, отсутствующие заголовки, лимиты API).

## Требования
- **Python 3.6+**: Убедитесь, что на вашей системе установлен Python 3.
- **Учетные данные Google Sheets API**:
  - Вам нужен файл `credentials.json` для аутентификации в Google Sheets API.
  - **Как получить `credentials.json`**:  
    1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/).
    2. Создайте новый проект (или выберите существующий).
    3. Включите Google Sheets API и Google Drive API:  
       - Перейдите в "APIs & Services" > "Library".  
       - Найдите "Google Sheets API" и "Google Drive API" и включите оба API.
    4. Создайте сервисный аккаунт:  
       - Перейдите в "IAM & Admin" > "Service Accounts".  
       - Нажмите "Create Service Account", заполните данные и создайте.  
       - Назначьте сервисному аккаунту роль "Editor" (или конкретные роли для Sheets и Drive).  
       - После создания выберите сервисный аккаунт, перейдите на вкладку "Keys", нажмите "Add Key" > "Create new key".  
       - Выберите формат "JSON" и скачайте файл ключа — это ваш `credentials.json`.  
    5. Поместите файл `credentials.json` в директорию проекта.
    6. Поделитесь своей таблицей Google Sheets с email сервисного аккаунта (например, `sheets-editor@your-project-id.iam.gserviceaccount.com`) с правами редактора.
- **Доступ к интернету**: Требуется для запросов к Wayback Machine и Google Sheets API.

## Установка
1. **Скачивание скрипта**:
   - Сохраните скрипт как `wayback_script.py` в директорию проекта (например, `~/wayback_project`).

2. **Установка зависимостей**:
   - Установите необходимые библиотеки Python:
     ```bash
     pip install gspread google-auth requests beautifulsoup4
     ```
   - Опционально, используйте виртуальное окружение:
     ```bash
     python3 -m venv venv
     source venv/bin/activate
     pip install gspread google-auth requests beautifulsoup4
     ```

3. **Настройка Google Sheets**:
   - Убедитесь, что URL вашей таблицы правильно указан в скрипте (`SPREADSHEET_URL`).
   - Таблица должна содержать хотя бы один лист с доменами в первом столбце (начиная с строки 2, строка 1 считается заголовком).

4. **Добавление `credentials.json`**:
   - Поместите файл `credentials.json` в ту же директорию, где находится скрипт.

## Использование
1. **Запуск скрипта**:
   - Перейдите в директорию проекта:
     ```bash
     cd ~/wayback_project
     ```
   - Если используется виртуальное окружение, активируйте его:
     ```bash
     source venv/bin/activate
     ```
   - Запустите скрипт:
     ```bash
     python3 wayback_script.py
     ```

2. **Проверка результатов**:
   - Результаты записываются в первый пустой столбец таблицы Google Sheets для каждого домена.
   - Если заголовок найден, он записывается как есть. Если нет, записывается сообщение об ошибке (например, "нет доступных снимков", "Ошибка: не удалось извлечь <title>" или "N/A").

3. **Просмотр логов**:
   - Логи сохраняются в файл `wayback_script.log` в директории проекта.
   - Проверьте этот файл для получения подробной информации о выполнении скрипта, включая ошибки и предупреждения.

## Запуск на сервере
1. **Подключение к серверу**:
   - Используйте SSH для подключения:
     ```bash
     ssh username@server_ip
     ```

2. **Настройка окружения**:
   - Установите Python и зависимости (см. раздел Установка выше).
   - Загрузите скрипт и `credentials.json` на сервер:
     ```bash
     scp wayback_script.py credentials.json username@server_ip:~/wayback_project/
     ```

3. **Запуск скрипта**:
   - Следуйте тем же шагам, что в разделе Использование.
   - Для фонового запуска:
     ```bash
     nohup python3 wayback_script.py &
     ```

4. **Автоматизация с помощью Cron** (опционально):
   - Настройте запуск скрипта ежедневно в 8 утра:
     ```bash
     crontab -e
     ```
     Добавьте следующую строку:
     ```bash
     0 8 * * * /bin/bash -c 'cd ~/wayback_project && source venv/bin/activate && python3 wayback_script.py >> ~/wayback_project/cron.log 2>&1'
     ```

## Устранение неполадок
- **"Permission Denied" для Google Sheets**:
  - Убедитесь, что email сервисного аккаунта имеет права редактора для таблицы.
- **"HTTPSConnectionPool... Read timed out"**:
  - Увеличьте `REQUEST_TIMEOUT` или `WAYBACK_REQUEST_DELAY` в скрипте.
  - Проверьте ваше интернет-соединение.
- **"Quota Exceeded" (ошибка Google Sheets API 429)**:
  - Скрипт автоматически ждёт 60 секунд и повторяет попытку.
  - Увеличьте `SHEETS_REQUEST_DELAY` или уменьшите `BATCH_SIZE`, чтобы снизить частоту запросов.
- **Проблемы с кодировкой лог-файла**:
  - Скрипт использует кодировку UTF-8. Убедитесь, что ваш текстовый редактор использует UTF-8 при просмотре `wayback_script.log`.

## Ограничения
- **Квоты Google Sheets API**:
  - Бесплатный тариф: ~60 запросов в минуту на пользователя.
  - При `BATCH_SIZE = 5` можно безопасно обработать ~200–250 доменов в минуту.
- **Доступ к Wayback Machine**:
  - Скрипт может столкнуться с таймаутами, если Wayback Machine работает медленно или ограничивает ваш IP.
  - Настройте `MAX_RETRIES` и `WAYBACK_REQUEST_DELAY` при необходимости.

## Лицензия
Скрипт предоставляется как есть для личного использования. Модифицируйте и распространяйте по необходимости.